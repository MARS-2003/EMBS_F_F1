enum State {RED, YELLOW, GREEN};

void setLights(State t);
const int tPins[] = {10, 9, 8}; 

const int RED_TIME = 3000;
const int YELLOW_TIME = 2000;
const int GREEN_TIME = 3000;

const int SHORT_DELAY = 800;

State curr = RED, prev;

bool pedReq = false;
int lastRxState = LOW;

void setLights(State t){
  for (int i = 0; i < 3; i++) digitalWrite(tPins[i], i == t ? HIGH : LOW); 
}

void setup(){
  for (int i = 0; i < 3; i++) pinMode(tPins[i], OUTPUT);
  pinMode(1, OUTPUT);
  pinMode(0, INPUT);

  setLights(RED); 
}



void checkRx() { 
  int RxState = digitalRead(0);
  if (RxState == HIGH){
    pedReq = true;
  }
}

void waitAndCheckRx(int ms) {
  for (int i = 0; i < ms; i += 20)
  {
    checkRx();
    if(pedReq){
      delay(SHORT_DELAY);
      return;
    }

    delay(20);
  }
}

void loop(){ 
  switch (curr){ 
    case RED:
      setLights(RED); 
      prev = RED;
      digitalWrite(1, HIGH);
      delay(RED_TIME);
      pedReq = false;
      digitalWrite(1, LOW);
      curr = YELLOW;
    break;

    case YELLOW:
      setLights(YELLOW);
      waitAndCheckRx(YELLOW_TIME);
      curr = (prev == RED) ? GREEN : RED;
    break;

    case GREEN:
      setLights(GREEN);
      waitAndCheckRx(GREEN_TIME);
      prev = GREEN;
      curr = YELLOW;
    break;
  }
}
