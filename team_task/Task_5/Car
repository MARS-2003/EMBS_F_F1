enum State {RED, YELLOW, GREEN};
void setLights(State t);


// Traffic Light Pins
const int tPins[] = {10, 9, 8}; 

const int RED_TIME = 3000;
const int YELLOW_TIME = 2000;
const int GREEN_TIME = 3000;
const int SHORT_DELAY = 800;

State curr = RED, prev;

bool pedReq = false;

void setLights(State t){
  for (int i = 0; i < 3; i++) digitalWrite(tPins[i], i == t ? HIGH : LOW); 
}

void setup(){
  for (int i = 0; i < 3; i++) pinMode(tPins[i], OUTPUT);
  Serial.begin(9600);

  setLights(RED); 
}

// Check Serial buffer for 'P' (Pedestrian Request)
void checkSerialRx() { 
  if (Serial.available() > 0) {
    char received = Serial.read();
    if (received == 'P'){
      pedReq = true;
    }
  }
}

// Wait function that periodically checks Serial for requests
void waitAndCheckRx(int ms) {
  for (int i = 0; i < ms; i += 20)
  {
    checkSerialRx();
    if(pedReq){
      delay(SHORT_DELAY);//end sooner if P is detact
      return;
    }
    delay(20);
  }
}

void loop(){ 
  switch (curr){ 
    case RED:
      setLights(RED); 
      prev = RED;
      
  
      Serial.write('1'); 
      
      delay(RED_TIME);
      
      pedReq = false;
      
      
      Serial.write('0'); 
      
      curr = YELLOW;
    break;

    case YELLOW:
      setLights(YELLOW);
      Serial.write('0'); 
      waitAndCheckRx(YELLOW_TIME);
      curr = (prev == RED) ? GREEN : RED;
    break;

    case GREEN:
      setLights(GREEN);
      Serial.write('0');
      waitAndCheckRx(GREEN_TIME);
      prev = GREEN;
      curr = YELLOW;
    break;
  }
}
